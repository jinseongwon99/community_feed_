<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PostMain</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
    }

    .story-list__item {
        background: #fff;
        border: 1px solid #ddd;
        margin: 20px auto;
        border-radius: 8px;
        overflow: hidden;
        max-width: 600px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .sl__item__header {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    .profile-image {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .sl__item__img img {
        width: 100%;
        display: block;
    }

    .sl__item__contents {
        padding: 10px;
    }

    .sl__item__contents__icon {
        display: flex;
        align-items: center;
    }

    .sl__item__contents__icon button {
        background: none;
        border: none;
        cursor: pointer;
        outline: none;
    }

    .sl__item__contents__content {
        margin-top: 10px;
    }

    .sl__item__contents__comment {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
    }

    .sl__item__input {
        display: flex;
        align-items: center;
        border-top: 1px solid #ddd;
        padding: 10px;
    }

    .sl__item__input input {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 5px 10px;
        outline: none;
    }

    .sl__item__input button {
        margin-left: 10px;
        padding: 5px 10px;
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 5px;
        cursor: pointer;
    }

    .sl__item__input button:hover {
        background-color: #0056b3;
    }
  </style>
</head>
<script>
  document.addEventListener('DOMContentLoaded', function() {
  const pathname = window.location.pathname; // URL 경로 가져오기
  const pathParts = pathname.split('/');     // '/'를 기준으로 분리
  const postId = pathParts[pathParts.length - 1]; // 마지막 부분이 'postId'

  if (postId) {
    const token = localStorage.getItem('accessToken');
    if (token) {
      fetch(`http://localhost:8080/post/getPost/${postId}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
        .then(response => response.json())
        .then(postData => {
          console.log('Post Data:', postData); // 응답 데이터 확인

          if (postData && postData.value) {
            const { post, comment } = postData.value;

            // 게시물 데이터 처리
            const postContent = post.content || '게시물 내용 없음';
            const postImageUrl = post.contentImageUrl
              ? `/uploads/images/${post.contentImageUrl}`
              : '/images/default-post-image.jpg';

            // 작성자 정보
            const userName = post.author?.info?.name || '사용자 이름';
            const userProfileImage = post.author?.info?.profileImage || '/images/person.jpeg';

            // 좋아요 수
            const likeCount = post.likeCount || 0;

            // HTML 업데이트
            document.getElementById('postUserName').innerText = userName;
            document.getElementById('postUserProfileImage').src = userProfileImage;
            document.getElementById('postImage').src = postImageUrl;
            document.getElementById('postContent').innerText = postContent;
            document.getElementById('storyLikeCount').innerText = likeCount;

            // 댓글 리스트 렌더링
            const commentList = document.getElementById('storyCommentList');
            commentList.innerHTML = ''; // 기존 댓글 제거

            comment.forEach(commentItem => {
              const commentElement = document.createElement('div');
              commentElement.classList.add('sl__item__contents__comment');
              commentElement.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                  <img class="profile-image" src="${commentItem.userProfileImageUrl || '/images/person.jpeg'}" onerror="this.src='/images/person.jpeg'" style="width: 30px; height: 30px; margin-right: 10px;" />
                  <b>${commentItem.userName}</b>
                </div>
                <p>${commentItem.content}</p>
                <small style="color: #888;">${new Date(commentItem.createdAt).toLocaleString()}</small>
              `;
              commentList.appendChild(commentElement);
            });
          } else {
            alert('게시물을 찾을 수 없습니다.');
          }
        })
        .catch(error => console.error('데이터 가져오기 오류:', error));
    } else {
      alert('로그인 토큰이 없습니다.');
    }
  } else {
    alert('잘못된 게시물 ID입니다.');
  }
});

function toggleLike() {
    const pathname = window.location.pathname; // URL 경로 가져오기
    const pathParts = pathname.split('/');     // '/'를 기준으로 분리
    const postId = pathParts[pathParts.length - 1]; // 마지막 부분이 'postId'
    const userId = 3;    // 실제로는 로그인된 유저의 ID  // 토큰값으로 usrId 가져오게 변경 해야함 ###############################

    const token = localStorage.getItem('accessToken');
    if (token) {
        fetch(`http://localhost:8080/post/like/${postId}/${userId}`, {
            method: 'GET',  // 좋아요는 POST 메소드로 변경
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Like response:', data);

            // 좋아요 수를 서버에서 받아와서 UI를 갱신
            if (data && data.value) {
                const updatedLikeCount = data.value || 0;
                document.getElementById('storyLikeCount').innerText = updatedLikeCount;
            }

            // 좋아요 버튼 아이콘 업데이트 (예: 좋아요 상태에 맞게 아이콘 색상 변경)
            const likeIcon = document.getElementById('storyLikeIcon');
            likeIcon.style.color = likeIcon.style.color === 'red' ? 'black' : 'red'; // 예시로 색상 변경
        })
        .catch(error => console.error('Error liking post:', error));
    } else {
        alert('로그인 토큰이 없습니다.');
    }
}



</script>
<body>
<div class="story-list__item" id="postItem">
  <div class="sl__item__header">
    <div>
      <img class="profile-image" src="#" onerror="this.src='/images/person.jpeg'" id="postUserProfileImage" />
    </div>
    <div id="postUserName">사용자 이름</div>
  </div>

  <div class="sl__item__img">
    <img src="#" id="postImage" />
  </div>

  <div class="sl__item__contents">
    <div class="sl__item__contents__icon" style="margin-top: 10px; margin-left: 5px;">
      <button style="margin-top: 7px;" onclick="toggleLike(123, 1)"> <!-- postId와 userId를 실제 데이터로 대체 -->
        <i class="fas fa-heart" id="storyLikeIcon"></i>
      </button>
      <span class="like"><b id="storyLikeCount">0</b> likes</span>
    </div>

    <br>
    <div class="sl__item__contents__content">
      <p id="postContent">게시물 내용</p>
    </div>

    <!-- 댓글 리스트 -->
    <div id="storyCommentList">
      <!-- 댓글이 동적으로 추가됩니다. -->
    </div>
    <br>

    <div class="sl__item__input">
      <input type="text" placeholder="댓글 달기..." id="storyCommentInput" />
      <button type="button" onclick="addComment('storyCommentList', 'storyCommentInput')">게시</button>
    </div>
  </div>
</div>



</body>
</html>
